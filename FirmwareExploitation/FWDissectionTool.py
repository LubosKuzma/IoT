# Program adapted from Colin O'Flynn's extraction techniques
# Created by Lubos Kuzma
# November 2021

# Program will extract firmware parts from binary file
# The user first needs to create a file defining firmware parts
# These parts can be defined using binwalk 

import sys, os

# Check the number of arguments
if len(sys.argv) != 3:
        print("Wrong number of arguments")
        print("Usage:")
        print("python3 extractor.py <parts_list_file> <bin_file>")
        exit()

# class that defines Firmware Part for extraction
class FWPart:                                                                                                                                                                                                                              
        def __init__(self, name, start, end):                                                                                                                                                                                              
                self.name = name                                                                                                                                                                                                           
                self.start = start                                                                                                                                                                                                         
                self.end = end                                                                                                                                                                                                             
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           
parts_list = []                                                                                                                                                                                                                            
# Open the parts list definition file and itterate through each line                                                                                                                                                                       
file = open(sys.argv[1], "r")                                                                                                                                                                                                              
for line in file:                                                                                                                                                                                                                          
        # ignore comment lines                                                                                                                                                                                                             
        if line[0] != '#':                                                                                                                                                                                                                 
                # splin lines into 3 parts (name, start, stop) using comma separator                                                                                                                                                        
                # and then strip the white space
                text_array = ([x.strip() for x in line.split(',')])
                # if the "stop" == "end" then calculate the length of the last section 
                if text_array[2] == 'end':
                        text_array[2] = hex(os.path.getsize(sys.argv[2])) 
                parts_list.append(FWPart(text_array[0], int(text_array[1], 16), int(text_array[2], 16)))
file.close()
# Open the bin file for extraction
bin_file = open(sys.argv[2], "rb")
# for each Firmware part object find that start byte and write out the length to another file
for fw_part in parts_list:
        out_file = open(fw_part.name, "wb")
        bin_file.seek(fw_part.start, 0)
        data = bin_file.read(fw_part.end - fw_part.start)
        out_file.write(data)
        out_file.close()
        print(f"Wrote {fw_part.name} - {hex(len(data))} bytes")

bin_file.close()
